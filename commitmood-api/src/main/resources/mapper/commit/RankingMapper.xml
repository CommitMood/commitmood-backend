<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.commitmood.domain.commit.mapper.RankingMapper">

    <resultMap id="rankingEntryResultMap"
               type="com.ssafy.commitmood.domain.commit.mapper.RankingMapper$RankingEntry">
        <result property="userAccountId" column="USER_ACCOUNT_ID"/>
        <result property="githubLogin" column="GITHUB_LOGIN"/>
        <result property="githubAvatarUrl" column="GITHUB_AVATAR_URL"/>
        <result property="commitCount" column="COMMIT_COUNT"/>
        <result property="flaggedCount" column="FLAGGED_COUNT"/>
        <result property="swearCount" column="SWEAR_COUNT"/>
        <result property="sentimentScore" column="SENTIMENT_SCORE"/>
        <result property="recentCommitCount" column="RECENT_COMMIT_COUNT"/>
    </resultMap>

    <!-- 커밋 수 기준 랭킹 -->
    <select id="findRankingByCommitCount" resultMap="rankingEntryResultMap">
        SELECT
            ua.USER_ACCOUNT_ID,
            ua.GITHUB_LOGIN,
            ua.GITHUB_AVATAR_URL,
            COUNT(cl.COMMIT_LOG_ID) AS COMMIT_COUNT,
            COALESCE(SUM(ca.FLAGGED_COUNT), 0) AS FLAGGED_COUNT,
            COALESCE(SUM(ca.SWEAR_COUNT), 0) AS SWEAR_COUNT,
            COALESCE(AVG(ca.SENTIMENT_SCORE), 0) AS SENTIMENT_SCORE,
            0 AS RECENT_COMMIT_COUNT
        FROM USER_ACCOUNT ua
                 LEFT JOIN COMMIT_LOG cl ON ua.USER_ACCOUNT_ID = cl.AUTHOR_USER_ACCOUNT_ID
                 LEFT JOIN COMMIT_ANALYSIS ca ON cl.COMMIT_LOG_ID = ca.COMMIT_LOG_ID
        GROUP BY ua.USER_ACCOUNT_ID, ua.GITHUB_LOGIN, ua.GITHUB_AVATAR_URL
        HAVING COUNT(cl.COMMIT_LOG_ID) > 0
        ORDER BY COMMIT_COUNT DESC, ua.GITHUB_LOGIN
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 플래그 토큰 수 기준 랭킹 -->
    <select id="findRankingByFlaggedCount" resultMap="rankingEntryResultMap">
        SELECT
            ua.USER_ACCOUNT_ID,
            ua.GITHUB_LOGIN,
            ua.GITHUB_AVATAR_URL,
            COUNT(cl.COMMIT_LOG_ID) AS COMMIT_COUNT,
            COALESCE(SUM(ca.FLAGGED_COUNT), 0) AS FLAGGED_COUNT,
            COALESCE(SUM(ca.SWEAR_COUNT), 0) AS SWEAR_COUNT,
            COALESCE(AVG(ca.SENTIMENT_SCORE), 0) AS SENTIMENT_SCORE,
            0 AS RECENT_COMMIT_COUNT
        FROM USER_ACCOUNT ua
                 LEFT JOIN COMMIT_LOG cl ON ua.USER_ACCOUNT_ID = cl.AUTHOR_USER_ACCOUNT_ID
                 LEFT JOIN COMMIT_ANALYSIS ca ON cl.COMMIT_LOG_ID = ca.COMMIT_LOG_ID
        GROUP BY ua.USER_ACCOUNT_ID, ua.GITHUB_LOGIN, ua.GITHUB_AVATAR_URL
        HAVING COALESCE(SUM(ca.FLAGGED_COUNT), 0) > 0
        ORDER BY FLAGGED_COUNT DESC, ua.GITHUB_LOGIN
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 욕설 수 기준 랭킹 -->
    <select id="findRankingBySwearCount" resultMap="rankingEntryResultMap">
        SELECT
            ua.USER_ACCOUNT_ID,
            ua.GITHUB_LOGIN,
            ua.GITHUB_AVATAR_URL,
            COUNT(cl.COMMIT_LOG_ID) AS COMMIT_COUNT,
            COALESCE(SUM(ca.FLAGGED_COUNT), 0) AS FLAGGED_COUNT,
            COALESCE(SUM(ca.SWEAR_COUNT), 0) AS SWEAR_COUNT,
            COALESCE(AVG(ca.SENTIMENT_SCORE), 0) AS SENTIMENT_SCORE,
            0 AS RECENT_COMMIT_COUNT
        FROM USER_ACCOUNT ua
                 LEFT JOIN COMMIT_LOG cl ON ua.USER_ACCOUNT_ID = cl.AUTHOR_USER_ACCOUNT_ID
                 LEFT JOIN COMMIT_ANALYSIS ca ON cl.COMMIT_LOG_ID = ca.COMMIT_LOG_ID
        GROUP BY ua.USER_ACCOUNT_ID, ua.GITHUB_LOGIN, ua.GITHUB_AVATAR_URL
        HAVING COALESCE(SUM(ca.SWEAR_COUNT), 0) > 0
        ORDER BY SWEAR_COUNT DESC, ua.GITHUB_LOGIN
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 감정 점수 기준 랭킹 -->
    <select id="findRankingBySentimentScore" resultMap="rankingEntryResultMap">
        SELECT
            ua.USER_ACCOUNT_ID,
            ua.GITHUB_LOGIN,
            ua.GITHUB_AVATAR_URL,
            COUNT(cl.COMMIT_LOG_ID) AS COMMIT_COUNT,
            COALESCE(SUM(ca.FLAGGED_COUNT), 0) AS FLAGGED_COUNT,
            COALESCE(SUM(ca.SWEAR_COUNT), 0) AS SWEAR_COUNT,
            COALESCE(AVG(ca.SENTIMENT_SCORE), 0) AS SENTIMENT_SCORE,
            0 AS RECENT_COMMIT_COUNT
        FROM USER_ACCOUNT ua
                 LEFT JOIN COMMIT_LOG cl ON ua.USER_ACCOUNT_ID = cl.AUTHOR_USER_ACCOUNT_ID
                 LEFT JOIN COMMIT_ANALYSIS ca ON cl.COMMIT_LOG_ID = ca.COMMIT_LOG_ID
        GROUP BY ua.USER_ACCOUNT_ID, ua.GITHUB_LOGIN, ua.GITHUB_AVATAR_URL
        HAVING COUNT(cl.COMMIT_LOG_ID) > 0
        ORDER BY SENTIMENT_SCORE DESC, ua.GITHUB_LOGIN
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 최근 활동 기준 랭킹 (최근 30일) -->
    <select id="findRankingByRecent" resultMap="rankingEntryResultMap">
        SELECT
            ua.USER_ACCOUNT_ID,
            ua.GITHUB_LOGIN,
            ua.GITHUB_AVATAR_URL,
            COUNT(DISTINCT all_cl.COMMIT_LOG_ID) AS COMMIT_COUNT,
            COALESCE(SUM(ca.FLAGGED_COUNT), 0) AS FLAGGED_COUNT,
            COALESCE(SUM(ca.SWEAR_COUNT), 0) AS SWEAR_COUNT,
            COALESCE(AVG(ca.SENTIMENT_SCORE), 0) AS SENTIMENT_SCORE,
            COUNT(DISTINCT recent_cl.COMMIT_LOG_ID) AS RECENT_COMMIT_COUNT
        FROM USER_ACCOUNT ua
                 LEFT JOIN COMMIT_LOG all_cl ON ua.USER_ACCOUNT_ID = all_cl.AUTHOR_USER_ACCOUNT_ID
                 LEFT JOIN COMMIT_LOG recent_cl ON ua.USER_ACCOUNT_ID = recent_cl.AUTHOR_USER_ACCOUNT_ID
            AND recent_cl.COMMITTED_AT >= #{startDate}
                 LEFT JOIN COMMIT_ANALYSIS ca ON all_cl.COMMIT_LOG_ID = ca.COMMIT_LOG_ID
        GROUP BY ua.USER_ACCOUNT_ID, ua.GITHUB_LOGIN, ua.GITHUB_AVATAR_URL
        HAVING COUNT(DISTINCT recent_cl.COMMIT_LOG_ID) > 0
        ORDER BY RECENT_COMMIT_COUNT DESC, ua.GITHUB_LOGIN
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 사용자 수 -->
    <select id="countTotalUsers" resultType="int">
        SELECT COUNT(DISTINCT ua.USER_ACCOUNT_ID)
        FROM USER_ACCOUNT ua
                 INNER JOIN COMMIT_LOG cl ON ua.USER_ACCOUNT_ID = cl.AUTHOR_USER_ACCOUNT_ID
    </select>

</mapper>