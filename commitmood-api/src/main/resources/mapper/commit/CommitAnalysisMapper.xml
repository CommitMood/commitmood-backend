<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.commitmood.domain.commit.repository.CommitAnalysisMapper">

    <!-- CommitAnalysis ResultMap -->
    <resultMap id="commitAnalysisResultMap" type="com.ssafy.commitmood.domain.commit.entity.CommitAnalysis">
        <id property="id" column="id"/>
        <result property="commitLogId" column="commit_log_id"/>
        <result property="flaggedCount" column="flagged_count"/>
        <result property="swearCount" column="swear_count"/>
        <result property="exclaimCount" column="exclaim_count"/>
        <result property="emojiCount" column="emoji_count"/>
        <result property="sentiment" column="sentiment"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="sentimentScore" column="sentiment_score"/>
        <result property="analyzedAt" column="analyzed_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- FlaggedToken ResultMap -->
    <resultMap id="flaggedTokenResultMap" type="com.ssafy.commitmood.domain.commit.entity.FlaggedToken">
        <id property="id" column="id"/>
        <result property="commitLogId" column="commit_log_id"/>
        <result property="token" column="token"/>
        <result property="tokenType" column="token_type"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="weight" column="weight"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 커밋 분석 정보 저장 -->
    <insert id="insert" parameterType="com.ssafy.commitmood.domain.commit.entity.CommitAnalysis"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO commit_analysis (
            commit_log_id,
            flagged_count,
            swear_count,
            exclaim_count,
            emoji_count,
            sentiment,
            sentiment_score,
            analyzed_at,
            created_at,
            updated_at
        ) VALUES (
                     #{commitLogId},
                     #{flaggedCount},
                     #{swearCount},
                     #{exclaimCount},
                     #{emojiCount},
                     #{sentiment},
                     #{sentimentScore},
                     #{analyzedAt},
                     NOW(),
                     NOW()
                 )
    </insert>

    <!-- 특정 커밋의 분석 정보 조회 -->
    <select id="findByCommitLogId" resultMap="commitAnalysisResultMap">
        SELECT
            id,
            commit_log_id,
            flagged_count,
            swear_count,
            exclaim_count,
            emoji_count,
            sentiment,
            sentiment_score,
            analyzed_at,
            created_at,
            updated_at
        FROM commit_analysis
        WHERE commit_log_id = #{commitLogId}
    </select>

    <!-- 특정 커밋의 플래그된 토큰 목록 조회 -->
    <select id="findFlaggedTokensByCommitLogId" resultMap="flaggedTokenResultMap">
        SELECT
            id,
            commit_log_id,
            token,
            token_type,
            weight,
            created_at,
            updated_at
        FROM flagged_token
        WHERE commit_log_id = #{commitLogId}
        ORDER BY weight DESC, token_type, token
    </select>

</mapper>